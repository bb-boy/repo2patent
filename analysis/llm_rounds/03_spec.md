# Round 3 说明书草案

## 说明书
### 技术领域
[0001] 本发明涉及工业数据处理技术领域，涉及一种双数据源工业波形数据处理方法及系统。

### 背景技术
[0002] 在工业测试、制造过程监测和设备运行分析场景中，波形数据来源通常同时包含离线文件链路和在线网络链路。离线链路用于导入既有采集文件，在线链路用于接收持续产生的数据消息。
[0003] 由于两类链路在触发方式、数据结构和处理时序上存在差异，现有系统容易出现字段映射不一致、状态定义不一致和跨链路查询路径分散的问题。
[0004] 元数据、波形数据、操作日志和PLC互锁日志属于不同数据类型。若全部数据采用统一存储策略，会在写入吞吐、查询组织和数据维护方面产生冲突。
[0005] 在双源并行运行场景中，主链路数据源不可用属于常见异常。现有方案若缺少统一切换和回退流程，将造成同步任务中断、状态不可追踪和恢复过程不确定。
[0006] 因此，需要一种双数据源工业波形数据处理技术方案，使数据接入、主题路由、分层持久化、查询反馈和异常切换形成闭环处理路径。

### 发明内容
[0007] 本发明的目的在于提供一种双数据源工业波形数据处理方法及系统，以解决双链路数据处理口径不一致、持久化路径冲突和异常场景连续服务不足的问题。
[0008] 为实现上述目的，根据本发明第一方面，提供一种双数据源工业波形数据处理方法。
[0009] 所述方法建立统一接入入口，接收来自TDMS文件链路和消息队列链路的数据，并基于统一字段模型执行标准化建模。所述统一字段模型至少包括shotNo、fileName、filePath、expectedDuration、actualDuration和status。
[0010] 在建模完成后，系统按预设主题进行消息路由，所述主题至少包括shot-metadata、wave-data、operation-log和plc-interlock，不同主题由独立消费者处理。各主题消费者采用分离部署和独立重试策略，在单一主题堆积或失败时不阻断其他主题处理路径。
[0011] 在持久化阶段，元数据、操作日志和PLC互锁日志写入关系型数据库；波形序列执行压缩编码后写入时序数据库。查询阶段按炮号、通道和时间窗口读取数据，并对压缩波形执行解压恢复，最终返回可直接用于曲线展示和分析计算的数据序列。
[0012] 在任务触发阶段，系统提供单任务同步、批量同步和全量同步三种模式，三种模式共享统一建模和路由流程。单任务模式用于指定炮号快速补数，批量模式用于多炮号并发处理，全量模式用于时间区间或目录范围内的统一同步。
[0013] 在容错阶段，系统持续检测主数据源可用性。检测到主数据源不可用时切换到备用数据源，主数据源恢复后执行回退切换，并记录切换前后状态用于任务审计和故障追踪。
[0014] 在结果反馈阶段，系统通过REST接口返回同步结果和查询结果，并通过WebSocket通道周期推送任务状态事件。状态事件至少包含任务开始、处理中、完成和失败，用于前端统一展示处理进度。
[0015] 在一个实施方式中，通道元数据查询优先读取数据库通道表，数据库无记录时读取通道元数据文件；若文件数据仍缺失，则返回默认通道集合以维持查询接口可用。
[0016] 根据本发明第二方面，提供一种双数据源工业波形数据处理系统，包括数据接入模块、标准化建模模块、消息路由模块、消费存储模块、查询服务模块和状态推送模块。
[0017] 根据本发明第三方面，提供一种计算机设备，包括处理器和存储器，所述处理器执行存储器中程序时实现上述方法步骤。
[0018] 根据本发明第四方面，提供一种计算机可读存储介质，其上存储有程序，所述程序被处理器执行时实现上述方法步骤。
[0019] 与现有技术相比，本发明至少具有以下有益效果：
[0020] 通过统一字段模型和统一入口，实现双源数据的一致建模和一致处理；
[0021] 通过主题路由与独立消费，实现链路解耦和模块隔离；
[0022] 通过关系型与时序型分层存储，实现结构化查询与波形查询的协同；
[0023] 通过主备切换与回退机制，实现异常场景下任务连续执行；
[0024] 通过接口与推送协同反馈，实现处理状态和结果的可追踪。

### 附图说明
[0025] 附图用于示出本发明实施方式，不用于限定本发明保护范围。
[0026] 图1为本发明实施例提供的系统总体架构图。
[0027] 图2为本发明实施例提供的数据处理流程图。
[0028] 图3为本发明实施例提供的模块关系图。

### 具体实施方式
[0029] 为使本发明的技术方案和有益效果更加清楚，以下结合附图和实施例对本发明进行说明。应当理解，所述实施例用于解释本发明，不用于限定本发明。
[0030] 实施例一提供一种双数据源工业波形数据处理方法。参见图2，所述方法以“统一接入、统一建模、主题路由、分层持久化、查询反馈、主备切换”为主线，具体包括如下步骤。
[0031] S101-S102，接收双源数据并执行标准化建模。系统在统一入口接收TDMS文件链路与网络消息链路的数据，针对每个任务生成唯一任务标识，并写入统一任务上下文；所述任务上下文至少包括任务编号、数据源类型、触发方式、接收时间和当前处理状态。随后系统解析shotNo、fileName、filePath、expectedDuration、actualDuration和status等字段形成标准化对象，并执行字段类型转换与状态归一化处理。对于缺失字段，系统写入空值标记和错误码，不中断主流程而进入后续可恢复处理分支。
[0032] S103-S104，执行主题路由与分主题消费。系统将标准化对象按shot-metadata、wave-data、operation-log和plc-interlock主题分发到对应消息通道，并根据主题类型设置消费优先级、重试次数和并发策略。路由键至少包含炮号标识和主题标识，以便同一炮号相关数据在消费侧进行有序聚合。在一个实施方式中，所述消息中间件采用Apache Kafka实现，所述shot-metadata、wave-data、operation-log和plc-interlock分别对应Kafka主题，生产端将标准化对象发送至对应主题，消费端按主题独立订阅并处理。消费阶段中，元数据写入炮号元数据表，操作日志写入操作日志表，PLC互锁日志写入互锁日志表；写库结果同步写入状态表，记录成功、失败及失败原因，用于后续重试调度与问题定位。
[0033] S105-S106，执行波形压缩存储与查询解压。波形消费者在写入前校验炮号与通道标识，对波形序列执行可逆压缩编码后写入时序数据库，并记录样本点数量、时间范围索引和通道关联信息。查询阶段中，查询服务按炮号、通道和时间窗口读取目标数据并执行对应解压过程，恢复原始数据点顺序；当请求包含多通道时，系统按通道顺序组装统一响应，响应中同时返回通道名称、样本点数量与时间范围信息，供前端绘图与比对分析。
[0034] S107-S109，执行同步触发、主备切换与状态反馈。系统提供单任务同步、批量同步和全量同步三种触发模式，三种模式复用同一处理管线，仅在任务装配方式与并发策略上存在差异：单任务模式用于指定炮号快速同步，批量模式用于炮号集合并行处理，全量模式用于扫描全部可用炮号并逐项处理。系统持续执行主数据源可用性检测，可用性检测至少包括连接可达性和读取能力检测；主源连续失败达到阈值时切换备用源，主源连续恢复达到阈值时回退主源。切换过程中保留任务上下文与未完成队列，避免任务丢失。处理结果通过REST接口返回，处理状态通过WebSocket周期推送；状态事件至少包括任务开始、处理中、完成和失败，并包含任务编号、炮号标识、当前步骤、更新时间和失败建议。
[0035] 为说明本方法的执行过程，以下给出一示例：当外部通过同步接口触发某炮号任务后，系统先完成S101-S102生成标准化对象，再经S103将对象按主题投递；结构化数据经S104写入关系型库，波形数据经S105写入时序库；查询请求到达后执行S106返回解压结果；若在执行期间主源不可用，则按S108切换备用源继续处理，同时由S109持续推送状态，直至任务完成或进入可重试状态。
[0036] 实施例二提供一种双数据源工业波形数据处理系统，参见图1和图3，所述系统包括数据接入模块、标准化建模模块、消息路由模块、消费存储模块、查询服务模块和状态推送模块。数据接入模块用于双源输入接收和任务初始化；标准化建模模块用于字段映射、类型转换和状态归一化；消息路由模块用于按主题分流并配置独立消费策略；消费存储模块用于执行分主题消费和分层持久化；查询服务模块用于检索、解压和统一响应组装；状态推送模块用于接口响应与实时状态推送，使前端状态与后端任务状态保持一致。
[0037] 在该系统实施方式中，数据接入模块包括主数据源单元、备用数据源单元和切换控制单元，切换控制单元依据可用性检测结果执行切换与回退；消息路由模块与状态推送模块协同工作，当某主题消费异常时生成异常状态事件并对外推送；查询服务模块同时提供数据查询接口和同步触发接口，使数据访问和任务调度通过统一服务入口完成。在一个实施方式中，消息路由模块和消费存储模块基于Kafka客户端组件实现主题发布与订阅，且为每个主题配置独立消费组，用于降低主题间处理耦合。
[0038] 实施例三提供一种计算机设备和一种计算机可读存储介质，处理器执行程序指令时实现实施例一的方法步骤。所述计算机设备至少包括处理器、存储器和通信接口；存储器中保存用于执行双源接入、标准化建模、主题路由、分层存储、查询解压、状态推送和主备切换的程序指令。所述计算机可读存储介质可以为磁盘、固态存储器或其他非易失存储介质。
[0039] 本领域技术人员在不偏离本发明构思的前提下，可对消息中间件实现、存储引擎实现或推送通道实现进行等效替换，所得技术方案均应落入本发明保护范围。

